<div class="close-out-side" (click)="close()">
  <div class="task-wrapper"
       (click)="$event.stopPropagation();"
       [class.hasBackground]="model?.coverId"
       [class.archived]="model?.archivedAt">
    <ng-container *ngIf="waiting">
      <div class="waiting-container">
        <app-waiting></app-waiting>
      </div>
    </ng-container>
    <ng-container *ngIf="!waiting">
      <div class="header" [style.backgroundImage]="getBackgroundUrl(model.coverId)">
        <div class="actions">
          <button [disabled]="togglingWatch" (click)="toggleWatch()" mat-mini-fab>
            <span class="btn-inner">
              <i *ngIf="!togglingWatch" class="icon-eye2"></i>
              <i *ngIf="togglingWatch" class="icon-spinner2 icon-spin"></i>
              <span class="sub-title">{{ 'WATCH' | translate }}</span>
            </span>
          </button>
          <button [disabled]="togglingArchive" (click)="toggleArchive()" *ngIf="permission !== AccessType.Visitor" mat-mini-fab>
            <span class="btn-inner">
              <i *ngIf="!togglingArchive" class="icon-archive"></i>
              <i *ngIf="togglingArchive" class="icon-spinner2 icon-spin"></i>
              <span class="sub-title">{{ 'ARCHIVE' | translate }}</span>
            </span>
          </button>
        </div>
        <div *ngIf="model.archivedAt" class="archived">
          <h4>{{ 'TASK_ARCHIVED_AT' | translate|stringFormat:(model.archivedAt | culturedDate)}}</h4>
        </div>
      </div>
      <div class="content">
        <div class="info">
          <div class="box">
            <button class="status-wrapper no-select" [disabled]="changingState || permission === AccessType.Visitor" [matMenuTriggerFor]="statusMenu">
            <span class="status-container">
              <span class="circle color-{{model.state}}"></span>
              <span class="text">
                {{model.state | enum:'WorkPackageTaskState'}}&nbsp;
                <i class="icon-arrow-down2"></i>
              </span>
            </span>
            </button>
            <div class="date">
              <ng-container *ngIf="model.dueAt || model.endAt || model.beginAt">
                <i class="icon-calendar"></i>&nbsp;
                <span>{{ (model.dueAt || model.endAt || model.beginAt) | culturedDate }}</span>
              </ng-container>
            </div>
            <div class="title">
              <ng-container *ngIf="!changingTitle">
                <i *ngIf="permission !== AccessType.Visitor" (click)="prepareChangeTitle()" class="icon-pencil"></i>
                <div>{{model.title}}</div>
              </ng-container>
              <ng-container *ngIf="changingTitle">
                <i *ngIf="!savingTitle" (click)="changeTitle()" class="icon-checkmark3"></i>
                <i *ngIf="savingTitle" class="icon-spin icon-spinner2"></i>
                <input [readOnly]="savingTitle" *ngIf="changingTitle" [placeholder]="'TASK_NEW_TITLE' | translate"
                       [(ngModel)]="newTitle" (keydown.enter)="changeTitle()" type="text">
              </ng-container>
            </div>
            <div class="list-name">
              {{ 'TASK_IN_LIST' | translate}}&nbsp;
              {{model.listName}}
            </div>
            <div class="description">
              <ng-container *ngIf="!changingDescription">
                <i *ngIf="permission !== AccessType.Visitor" (click)="prepareChangeDescription()" class="icon-pencil"></i>
                <div *ngIf="model.description" class="has-description">{{model.description}}</div>
                <div *ngIf="!model.description" class="no-description">{{'NO_DESCRIPTION_YET' | translate}}</div>
              </ng-container>
              <ng-container *ngIf="changingDescription">
                <i *ngIf="!savingDescription" (click)="changeDescription()" class="icon-checkmark3"></i>
                <i *ngIf="savingDescription" class="icon-spin icon-spinner2"></i>
                <textarea [readOnly]="savingDescription"
                          rows="2" [placeholder]="'TASK_NEW_DESCRIPTION' | translate"
                          [(ngModel)]="newDescription" type="text"></textarea>
              </ng-container>

            </div>
          </div>
          <div class="box">
            <h3>{{ 'COMMENTS' | translate}}</h3>
            <div class="comment-container">
              <div *ngIf="permission !== AccessType.Visitor" class="send">
                <div class="avatar">
                  <app-member-info [small]="true" [me]="true"></app-member-info>
                </div>
                <div class="text">
                  <textarea [readOnly]="commenting" [(ngModel)]="comment" [placeholder]="'ENTER_YOUR_COMMENT' | translate" rows="3"></textarea>
                  <button (click)="sendComment()" [disabled]="commenting || !comment || !comment.trim().length">
                    <i [class]="commenting ? 'icon-spin icon-spinner2' : 'icon-paperplane'"></i>
                  </button>
                </div>
              </div>
              <div class="comments">
                <div *ngFor="let comment of model.comments" class="comment">
                  <div class="avatar">
                    <app-member-info [small]="true" [id]="comment.userId" [(model)]="comment.member"></app-member-info>
                  </div>
                  <div class="more">
                    <div class="full-name">
                      <span class="name">{{comment.member?.fullName}}</span>
                      <span class="when">{{comment.createdAt | culturedDate}}</span>
                    </div>
                    <div class="message">{{comment.message}}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="detail">
          <ul class="tabs">
            <li [class.active]="mode === ViewMode.Detail" (click)="switchMode(ViewMode.Detail)">{{'TASK_DETAILS' | translate}}</li>
            <li [class.active]="mode === ViewMode.TimeSpent" (click)="switchMode(ViewMode.TimeSpent)">{{'TASK_TIME_SPENT' | translate}}</li>
            <li [class.active]="mode === ViewMode.Related" (click)="switchMode(ViewMode.Related)">{{'TASK_RELATED' | translate}}</li>
            <li [class.active]="mode === ViewMode.CustomField" (click)="switchMode(ViewMode.CustomField)">{{'TASK_CUSTOM_FIELD' | translate}}</li>
            <li [class.active]="mode === ViewMode.Activity" (click)="switchMode(ViewMode.Activity)">{{'TASK_ACTIVITY' | translate}}</li>
          </ul>
          <div class="tab-content">
            <ng-container *ngIf="mode === ViewMode.Detail">
              <div class="box-container">
                <div class="header">
                  <div class="title">{{'TASK_DETAILS' | translate}}</div>
                  <div class="action">
                    <button *ngIf="permission !== AccessType.Visitor" mat-mini-fab color="primary"><i class="icon-plus2"></i></button>
                  </div>
                </div>
                <div class="box">
                  <div class="box-header">
                    <i class="icon-price-tags4"></i>
                    <span>{{ 'TASK_LABELS' | translate}}</span>
                    <i *ngIf="permission !== AccessType.Visitor" [matMenuTriggerFor]="labelMenu" class="add icon-plus2"></i>
                  </div>
                  <div class="box-content">
                    <div *ngIf="!model.labels.length" class="no-item">
                      <h3>{{ 'TASK_NO_LABELS' | translate}}</h3>
                    </div>
                    <div class="labels">
                      <ng-container *ngFor="let label of workPackage.labels">
                      <span *ngIf="isLabelSelected(label)"
                            [style.background]="label.color">{{label.title}}</span>
                      </ng-container>
                    </div>
                  </div>
                  <mat-menu #labelMenu="matMenu" class="popper-task-labels">
                    <div class="task-modal-labels-menu" (click)="$event.preventDefault();$event.stopPropagation()">
                      <ul>
                        <li (click)="toggleLabel(label)" *ngFor="let label of workPackage.labels">
                          <div class="label" [class.selected]="isLabelSelected(label)">
                            <div class="title">
                              <span *ngIf="!label.editting" [style.background]="label.color">
                                {{label.title}}
                                <ng-container *ngIf="!label.title">
                                  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                </ng-container>
                              </span>
                              <ng-container *ngIf="label.editting">
                                <input [disabled]="label.waiting" type="text" [(ngModel)]="label.tempName">
                                <i *ngIf="!label.waiting" (click)="saveLabelName(label)"
                                   class="icon-checkmark3"></i>
                                <i *ngIf="label.waiting" class="icon-spinner2 icon-spin"></i>
                              </ng-container>
                            </div>
<!--                            <i *ngIf="label.waiting" class="icon-spin icon-spinner2"></i>-->
                            <i *ngIf="!label.waiting && !label.editting" (click)="prepareRenameLabel(label, $event)" class="icon-pencil"></i>
                            <i *ngIf="!label.waiting && !label.editting" (click)="deleteLabel(label, $event)" class="icon-delete"></i>
                          </div>
                        </li>
                      </ul>
                    </div>
                  </mat-menu>
                </div>
                <div class="box">
                  <div class="box-header">
                    <i class="icon-users2"></i>
                    <span>{{ 'TASK_MEMBERS' | translate}}</span>
                    <i *ngIf="permission !== AccessType.Visitor" [matMenuTriggerFor]="memberMenu" class="add icon-plus2"></i>
                  </div>
                  <div class="box-content">
                    <div *ngIf="!model.members.length" class="no-item">
                      <h3>{{ 'TASK_NO_MEMBERS' | translate}}</h3>
                    </div>
                    <div class="members">
                      <ng-container *ngFor="let member of model.members;">
                        <app-member-info *ngIf="!member.isGroup" [small]="true"
                                         [id]="member.recordId"
                        ></app-member-info>
                        <app-group-info *ngIf="member.isGroup" [small]="true"
                                        [id]="member.recordId"
                        ></app-group-info>
                      </ng-container>
                    </div>
                  </div>

                  <mat-menu #memberMenu="matMenu">
                    <div class="task-modal-members-menu" (click)="$event.preventDefault();$event.stopPropagation()">
                      <ul>
                        <li (click)="toggleMember(member)"
                            *ngFor="let member of project.members;">
                          <app-member-info [selected]="isMemberSelected(member)"
                                           *ngIf="!member.isGroup"
                                           [model]="member.member"
                                           [id]="member.recordId"
                          ></app-member-info>
                          <app-group-info [selected]="isMemberSelected(member)"
                                          *ngIf="member.isGroup"
                                          [id]="member.recordId"
                          ></app-group-info>
                        </li>
                      </ul>
                    </div>
                  </mat-menu>
                </div>
                <div class="box" *ngIf="showSubTasks || model.subTasks.length">
                  <div class="box-header">
                    <i class="icon-tree7"></i>
                    <span>{{ 'TASK_SUB_TASK' | translate}}</span>
                    <i (click)="prepareSubTask()" class="add icon-plus2"></i>
                  </div>
                  <div class="box-content sub-tasks-wrapper">
                    <app-work-package-task *ngFor="let sub of model.subTasks"
                                           [model]="sub"
                                           [project]="project"
                                           [workPackage]="workPackage"></app-work-package-task>
                  </div>
                </div>
                <div class="box">
                  <div class="box-header">
                    <i class="icon-attachment"></i>
                    <span>{{ 'TASK_ATTACHMENTS' | translate}}</span>
                    <i *ngIf="permission !== AccessType.Visitor" [matMenuTriggerFor]="attachmentMenu" class="add icon-plus2"></i>
                  </div>
                  <div class="box-content">
                    <div *ngIf="!model.attachments.length" class="no-item">
                      <h3>{{ 'TASK_NO_ATTACHMENTS' | translate}}</h3>
                    </div>
                    <ng-container *ngFor="let upload of filesService.attaching">
                      <div class="attachment-item" *ngIf="upload.recordId === id">
                        <div class="preview">
                          <i [class]="filesService.icon(upload.name)"></i>
                        </div>
                        <div class="info">
                          <h4>{{ upload.name}}</h4>
                          <h5 [class.success]="upload.success"
                              [class.failed]="upload.failed">
                            <mat-progress-bar [value]="upload.progress"></mat-progress-bar>
                          </h5>
                          <h5>
                            <span>{{ 'UPLOADING' | translate}}&nbsp;</span>
                          </h5>
                        </div>
                        <div class="actions">

                        </div>
                      </div>
                    </ng-container>
                    <div class="attachment-item" *ngFor="let attachment of model.attachments">
                      <div class="preview">
                        <i [class]="filesService.icon(attachment.path)"></i>
                      </div>
                      <div class="info">
                        <h4 *ngIf="!attachment.renaming">{{ attachment.title}}</h4>
                        <div *ngIf="attachment.renaming">
                          <input [readOnly]="attachment.waiting" type="text" [(ngModel)]="attachment.tempName">
                          <i (click)="renameAttachment(attachment)" *ngIf="!attachment.waiting" class="rename icon-checkmark3"></i>
                          <i *ngIf="attachment.waiting" class="rename icon-spinner2 icon-spin"></i>
                        </div>
                        <h5>{{ attachment.createdAt | culturedDate:true }}</h5>
                        <h5>
                          <span>{{ 'UPLOADED_BY' | translate}}&nbsp;</span>
                          {{usersService.findUser(attachment.userId)?.fullName}}
                        </h5>
                      </div>
                      <div class="actions">
                        <div class="btns">
                          <i class="icon-new-window" (click)="openAttachment(attachment)"></i>
                          <i class="icon-download41" (click)="downloadAttachment(attachment)"></i>
                          <i *ngIf="permission !== AccessType.Visitor" class="icon-pencil" (click)="editAttachment(attachment)"></i>
                          <i *ngIf="permission !== AccessType.Visitor" class="icon-delete" (click)="deleteAttachment(attachment)"></i>
                        </div>
                        <div *ngIf="permission !== AccessType.Visitor" class="cover">
                          <a (click)="coverToggle(attachment)" href="javascript:void(0)">
                            <ng-container *ngIf="attachment.covering">
                              <i class="icon-spin icon-spinner2"></i>&nbsp;
                            </ng-container>
                            {{ (attachment.isCover ? 'REMOVE_COVER' : 'MAKE_COVER') | translate}}
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                  <input
                    #filePicker
                    (change)="onChange($event.target)"
                    [accept]="allowedTypes"
                    multiple
                    hidden
                    type="file"
                  />
                  <mat-menu #attachmentMenu="matMenu">
                    <button (click)="prepareUpload()" mat-menu-item>
                      <i class="icon-file-pdf"></i>
                      {{ 'UPLOAD_FILE' | translate }}
                    </button>
                    <button (click)="prepareChoose()" mat-menu-item>
                      <i class="icon-link2"></i>
                      {{ 'CHOOSE_FILE' | translate }}
                    </button>
                  </mat-menu>
                </div>
              </div>
            </ng-container>
            <ng-container *ngIf="mode === ViewMode.TimeSpent">2</ng-container>
            <ng-container *ngIf="mode === ViewMode.Related">3</ng-container>
            <ng-container *ngIf="mode === ViewMode.CustomField">4</ng-container>
            <ng-container *ngIf="mode === ViewMode.Activity">5</ng-container>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
</div>
<mat-menu #statusMenu="matMenu">
    <div class="status-popper">
      <ul class="status-wrapper">
        <li (click)="changeState(state)" *ngFor="let state of allStates" class="status-container">
          <div class="circle color-{{state}}"></div>
          <div class="text">
            {{state | enum:'WorkPackageTaskState'}}
          </div>
        </li>
      </ul>
    </div>
</mat-menu>
